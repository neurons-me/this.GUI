# This.GUI ‚Äî Theme Engine (v2)
**Token‚Äëfirst. Manifest‚Äëdriven.**  
Compiles **JSON tokens** into an MUI theme at runtime. Each **theme** now has **modes** (typically `light` and `dark`) defined by a **manifest**; we also export **CSS variables** and coordinate **insets** (bars/drawers) via `GuiProvider`.

---

## TL;DR
- **Tokens**: describe design values (colors, spacing, motion, ‚Ä¶).  
- **Manifest**: describes the *theme* (id, name, icon, modes and where their tokens live).  
- **fromTokens**: `makeMuiTheme(globalTokens, modeTokens, mode)` produces an MUI theme.  
- **getTheme**: builds a theme from `tokens`, from a `manifest`, or from **built‚Äëins**.  
- **GuiProvider**: stores the active `family+mode`, injects **CSS vars** and coordinates **insets**.  
- **Selector/Toggle**: UI to switch between `light`/`dark` of the active theme.  
- **AppBar note**: MUI only supports `default | primary | secondary | transparent`. Other colors ‚Üí use `sx`.

---

## Recommended structure

```
src/themes/
  tokens/
    global.tokens.json               # shared base (radius, spacing, motion‚Ä¶)
    neurons/
      manifest.json                  # describes the "neurons.me" theme
      light.tokens.json              # light‚Äëmode tokens (values only, no metadata)
      dark.tokens.json               # dark‚Äëmode tokens  (values only, no metadata)
  fromTokens.ts                      # compiler tokens ‚Üí MUI theme
  index.js                           # built‚Äëin registry + public factories
  theme.d.ts                         # optional DX types
```

### Manifest (what it is and what it contains)
- **Identity**: `id`, `name`, `description`, `author`, `version`, etc.
- **Where tokens are**: `modes.light.path` and `modes.dark.path`.
- **Theme icon**: `icon` (optional).  
  - Supported:
    ```ts
    type ThemeIcon =
      | { type: 'mui' | 'lucide'; value: string } // icon-set name
      | { type: 'url'; value: string }            // path to .svg/.png
      | { type: 'svg'; value: string }            // inline SVG
      | { type: 'data'; value: string };          // data URI
    ```
- **Important**: we **no longer** keep `preview` or metadata inside token files; the preview is **derived** from the theme (e.g. `palette.background.default`, `palette.primary.main`, `palette.link.main`, etc.).

**Example `manifest.json`:**
```json
{
  "id": "neurons.me",
  "name": "neurons.me",
  "description": "A modern, flexible theme for Neuroverse.",
  "author": "suiGn",
  "version": "1.0.0",
  "license": "MIT",
  "icon": { "type": "mui", "value": "Palette" },
  "modes": {
    "light": { "path": "./light.tokens.json" },
    "dark":  { "path": "./dark.tokens.json" }
  }
}
```

---

## Tokens (what goes inside)
Token files contain **values only**. If you use Tokens Studio, keep the `{"$value": ...}` shape; the compiler understands it.

**Example `light.tokens.json` (trimmed):**
```json
{
  "color": {
    "primary":       { "$value": "#0a3a42" },
    "secondary":     { "$value": "#e5396f" },
    "icon":          { "$value": "#5e5e5e" },
    "bgDefault":     { "$value": "#f8f9fa" },
    "bgPaper":       { "$value": "#ffffff" },
    "bgNav":         { "$value": "#fdfdfd" },
    "textPrimary":   { "$value": "#111111" },
    "textSecondary": { "$value": "#444444" },
    "link":          { "$value": "#008c7d" },
    "linkVisited":   { "$value": "#006e64" },
    "border":        { "$value": "rgba(0,0,0,0.08)" }
  }
}
```

---

## Compiler (`fromTokens.ts`)
**Primary API**
```ts
makeMuiTheme(globalTokens: any, modeTokens: any, mode: 'light'|'dark'): Theme
```

- Maps colors into `theme.palette`:
  - `color.primary` ‚Üí `palette.primary.main`
  - `color.secondary` ‚Üí `palette.secondary.main`
  - `color.bgDefault` ‚Üí `palette.background.default`
  - `color.bgPaper` ‚Üí `palette.background.paper`
  - `color.bgNav` ‚Üí `palette.background.nav` *(custom key)*
  - `color.textPrimary` / `color.textSecondary` ‚Üí `palette.text.*`
  - `color.link` / `color.linkVisited` ‚Üí `palette.link.*` *(custom key)*
  - Semantic (`extendedColors.*`): `success`, `warning`, `error`, `info`
- Exposes **all** tokens again under `theme.custom.*` for a stable access surface.
- Builds `breakpoints`, `zIndex`, `typography`, `shadows`, `transitions`, etc.
- Injects **CSS variables** via `MuiCssBaseline`:
  - `--gui-primary`, `--gui-secondary`, `--gui-bg-default`, `--gui-bg-paper`,  
    `--gui-bg-nav`, `--gui-text-primary`, `--gui-text-secondary`,  
    `--gui-link`, `--gui-link-visited`, `--gui-border`, etc.

**Manifest mode (optional)**  
When needed, `makeMuiThemeFromManifest(manifest, { mode })` reads tokens from `manifest.modes[mode].tokens` and calls `makeMuiTheme(...)` internally.

---

## Registry & factories (`themes/index.js`)
- **Built‚Äëins**: we register `neurons` with its `manifest` and `light/dark` tokens.
- **createThemeFromTokens(tokens, mode)**: thin shortcut to `makeMuiTheme(...)`.
- **createThemeFromManifest(manifest, mode, tokensByMode?)**: uses manifest + (optional) map `{ light, dark }`.
- **getTheme**  
  ```ts
  // options: { key?: string; manifest?: any; tokens?: any; mode: 'light' | 'dark' }
  ```
  - If you pass `tokens`: it prioritizes `createThemeFromTokens`.
  - If you pass a `manifest`: it prioritizes `createThemeFromManifest`.
  - If you pass a built‚Äëin `key`: it resolves from the registry (`neurons` + `mode`).
- **AVAILABLE_THEMES**: flat list derived from built‚Äëins:
  ```ts
  type AvailableTheme = {
    id: string;         // e.g. "neurons-light"
    family: string;     // e.g. "neurons"
    name: string;       // e.g. "neurons.me Light"
    mode: 'light'|'dark';
    manifest: any;
  }
  ```

---

## GuiProvider (coordination & context)
`GuiProvider`:

1) **Active theme state**  
   - Stores `themeKey` (e.g. `neurons-dark`) in `localStorage` (`this.gui:theme`).  
   - Derives `family` + `mode` from `AVAILABLE_THEMES`.  
   - Exposes helpers: `setMode('light'|'dark')`, `setFamilyAndMode(family, mode)`, `toggleMode()`.

2) **Compiles and extends the theme**  
   - Calls `getTheme({ key: active.id })`.  
   - Injects `theme.layout.insets` and `theme.updateInsets(cb)`.  
   - Syncs CSS vars: `--gui-inset-left/right` and `--gui-nav-height`.

3) **How components consume it**  
   - Use MUI‚Äôs `useTheme()` ‚Üí you get **MUI + GuiProvider extensions**.  
   - Use `useMediaQuery(theme.breakpoints.*)` for consistent responsiveness.  
   - Read/update insets via `theme.layout.insets` and `theme.updateInsets`.

**Hook**
```ts
import { useThemeContext } from '@/context/GuiProvider';

const { family, mode, toggleMode, setMode, setFamilyAndMode, availableFamilies } = useThemeContext();
```

---

## Selector & Toggle
- **ThemeSelector**: shows the *theme name* (family), a derived **preview**, and a **toggle** (üåû/üåô) aligned to the right.  
- **Previews**: derived from the active theme (e.g. `background.default`, `primary.main`, `secondary.main`, `link.main`, etc.). You can increase the grid and show tooltips with the token name.

---

## Compatibility notes (MUI)
- **AppBar `color`** supports `default | primary | secondary | transparent`.  
  - If you want `success | info | warning | error` or any custom color, use `sx`:
    ```jsx
    <AppBar
      color="transparent"
      sx={{
        bgcolor: (t) => t.palette.success.main,
        color:  (t) => t.palette.getContrastText(t.palette.success.main)
      }}
    />
    ```
- The rest of the components respect your `palette` and accept granular `sx`.

---

## Examples
### 1) Use a built‚Äëin (neurons dark)
```ts
import { getTheme } from '@/themes';
const theme = getTheme({ key: 'neurons', mode: 'dark' });
```

### 2) Use ‚Äúad‚Äëhoc‚Äù tokens (no manifest)
```ts
import { getTheme } from '@/themes';
import myTokens from './my.light.tokens.json';

const theme = getTheme({ tokens: myTokens, mode: 'light' });
```

### 3) Switch mode from UI
```tsx
import { useThemeContext } from '@/context/GuiProvider';

function ModeToggle() {
  const { mode, toggleMode } = useThemeContext();
  return <Switch checked={mode === 'dark'} onChange={toggleMode} />;
}
```

---

## Troubleshooting
**‚ÄúI don‚Äôt see my themes in the selector.‚Äù**  
- Make sure `themes/index.js` registers your theme in `BUILT_IN` and that `AVAILABLE_THEMES` includes it.  
- For an external theme, use `getTheme({ manifest, tokensByMode })` or `getTheme({ tokens })`.

**‚ÄúAppBar won‚Äôt change to ‚Äòsuccess‚Äô.‚Äù**  
- That‚Äôs expected: use `sx` as shown above.

**‚ÄúI want pre‚Äëpainted CSS to avoid FOUC.‚Äù**  
- You can generate a `tokens.css` at *build time* with default variables; `GuiProvider` will re‚Äëhydrate at runtime.

---

## Final mental model
- **JSON tokens** define the design truth.  
- **Manifest** describes the theme (icon, modes, and token locations).  
- **fromTokens** compiles to **MUI theme** + `theme.custom.*` + **CSS vars**.  
- **GuiProvider** selects `family+mode`, persists it, adds **insets**, and exposes helpers.  
- **Components** consume the theme and style granularly with `sx` ‚Äî mature, flexible, no lock‚Äëin, ready for AI.
